<% include ./partials/trainerFields %>

<% function checkingItemsHelper(keys, names){
    if(keys.length != names.length){
        throw new Error('Names and keys collections must match!');
    }
    for(let i = 0; i < keys.length; i++){ 
        let key = keys[i];
        let val = names[i]; 
         %>
        <li class="form-check">
            <label class="form-check-label">
                <input class="form-check-input" type="checkbox" value="1" name="<%- key %>" />
                <%- val %>
            </label>
        </li>
    <%
    } 
} %>

<script type="text/javascript" src="/assan/js/plugins/plugins.js"></script> 
<script type="text/javascript" src="/assan/js/assan.custom.js"></script> 

<div class="bg-parallax parallax-overlay listing-page-container hero-search" data-jarallax='{"speed": 0.2}' style='background-image: url("/images/pics/4.jpg");'>
    <div class="container">
        <h2 class="text-white h1 font700 mb30 pb30 text-center">Znajdź trenera i osiągnij swój cel</h2>
    </div>
</div><!--Hero-->

<div class="container pt90 pb50">
    <div class="row">            
            <div class="col-md-3 col-sm-3 col-xs-3 mb40">
                <form role="form" id="search-form" action="/trainers">
                    <div class="pb30">
                        <h4 class="sidebar-title">Szukam:</h4>
                        <select class="form-control" id="type" name="type">
                            <option value="trainer">Trenera osobistego</option>
                            <option value="consultant">Konsultanta dyjetytycznego</option>
                        </select>
                    </div>

                    <div class="pb30 city-select">
                        <h4 class="sidebar-title">Miasto:</h4>
                        <select class="form-control" id="city" name="city">
                            <option value="0">Dowolne</option>
                            <option value="1">Warszawa</option>
                            <option value="2">Kraków</option>
                            <option value="3">Łódź</option>
                            <option value="4">Wrocław</option>
                            <option value="5">Poznań</option>
                            <option value="6">Gdańsk</option>
                            <option value="7">Szczecin</option>
                        </select>
                    </div>

                    <div class="mb40 sport-fields">
                        <h4 class="sidebar-title">Jaki masz cel:</h4>
                        <ul class="list-unstyled categories">
                            <% checkingItemsHelper(trainHelpFields, trainHelpSearchNames); %>
                        </ul>
                    </div>

                    <div class="mb40 feed-fields">
                        <h4 class="sidebar-title">Jaki masz cel:</h4>
                        <ul class="list-unstyled categories">
                            <% checkingItemsHelper(feedHelpFields, feedHelpSearchNames); %>
                        </ul>
                    </div>

                    <div class="mb40 sport-fields">
                        <h4 class="sidebar-title">Dyscyplina sportowa:</h4>
                        <ul class="list-unstyled categories">
                            <% checkingItemsHelper(trainFields, trainNames); %>
                        </ul>
                    </div>

                    <div class="mb40 feed-fields">
                        <h4 class="sidebar-title">Specjalizacja dietetyczna:</h4>
                        <ul class="list-unstyled categories">
                             <% checkingItemsHelper(feedFields, feedNames); %>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="col-md-9 col-sm-9 col-xs-9 mb40">
                <%- include ./partials/trainersList %>                  
            </div>
    </div>
</div>

<script type="text/javascript">
    $('.trainers-list').css('opacity','1');
    function reloadData(query) {
        $.get('/listingPartial?' + query,function(data){
            try{
                var stateObj = { query: query };
                history.pushState(stateObj, document.title, "/trainers?"+query);
            }
            catch(ex){
                console.error(ex);
            }
            $('.trainers-list').replaceWith(data);
            setTimeout(function() {
                $('.trainers-list').css('opacity','1');
            }, 100);                        
        });        
    }

    let sendForm = function() {
        $('.trainers-list').css('opacity','0.2');
        var query = $('#search-form').serialize();
        reloadData(query);
    }

    let sendTimer = null;

    let sendFormDebounce = function() {
        clearTimeout(sendTimer);
        sendTimer = setTimeout(sendForm, 1000);
    }

    let setCorrestpondingCheckboxes = function(isSelectedTrainer){
        let trainerFields = [];
        let feedFields = [];
        $('.sport-fields input').each(function(i, el){trainerFields.push($(el).attr('name'))});
        $('.feed-fields input').each(function(i, el){feedFields.push($(el).attr('name'))});

        for(let i = 0; i < trainerFields.length; i++){
            let feedFieldName = trainerFields[i].replace('isTrain','isFeed');
            if(feedFields.find(f => f == feedFieldName)){
                if(isSelectedTrainer){
                    $(`input[name=${trainerFields[i]}]`).prop('checked', $(`input[name=${feedFieldName}]`).prop('checked'));
                }else{
                    $(`input[name=${feedFieldName}]`).prop('checked', $(`input[name=${trainerFields[i]}]`).prop('checked'));
                }
            }
        }
    }

    let setFieldsType = function(type, isInitial) {
        if(type == 'consultant'){
            $('.city-select, .sport-fields').hide();
            $('.city-select input, .sport-fields input').attr('disabled', 'disabled');

            $('.feed-fields input').removeAttr('disabled');
            $('.feed-fields').show();
            if(!isInitial) setCorrestpondingCheckboxes(false);
        }else if(type == 'trainer'){
            $('.city-select input').removeAttr('disabled');
            $('.city-select').show();

            $('.feed-fields').hide();
            $('.feed-fields input').attr('disabled', 'disabled');

            $('.sport-fields input').removeAttr('disabled');
            $('.sport-fields').show();
            if(!isInitial) setCorrestpondingCheckboxes(true);
        }

        //
    }

    let parseQueryString = function() {

        let str = window.location.search;
        let objURL = {};

        str.replace(
            new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
            function( $0, $1, $2, $3 ){
                objURL[ $1 ] = $3;
            }
        );
        return objURL;
    };

    var params = parseQueryString();
    for(let key in params){
        let element = $('[name=' + key + ']')
        if(element.attr('type') == 'checkbox'){
            if(params[key]){
                element.attr('checked','checked');
                element.prop('checked', true);
            }
        }else{

        }
        element.val(params[key]);
    }

    setFieldsType(params['type'], true);

    $('select').change(function(event){
        if($(this).attr('name') == 'type'){
            setFieldsType($(this).val());
        }
        sendFormDebounce();
    });

    $('input').change(function(event){
        sendFormDebounce();
    });
</script>